<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.aukey.report.mapper.centerstock.CenterStockReportMapper" >
  <resultMap id="BaseResultMap" type="com.aukey.report.domain.centerstock.CenterStockReport" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jan 17 17:08:28 CST 2018.
    -->
    <result column="id" property="id" jdbcType="INTEGER" />
    <result column="sku" property="sku" jdbcType="VARCHAR" />
    <result column="upc" property="upc" jdbcType="VARCHAR" />
    <result column="sku_name" property="skuName" jdbcType="VARCHAR" />
    <result column="dept_id" property="deptId" jdbcType="INTEGER" />
    <result column="dept_name" property="deptName" jdbcType="VARCHAR" />
    <result column="fba_transfer" property="fbaTransfer" jdbcType="INTEGER" />
    <result column="fba_stock_count" property="fbaStockCount" jdbcType="DECIMAL" />
    <result column="oversea_stock_transfer" property="overseaStockTransfer" jdbcType="DECIMAL" />
    <result column="oversea_stock_count" property="overseaStockCount" jdbcType="DECIMAL" />
    <result column="first_air_transfer" property="firstAirTransfer" jdbcType="DECIMAL" />
    <result column="first_ship_transfer" property="firstShipTransfer" jdbcType="DECIMAL" />
    <result column="first_trains_transfer" property="firstTrainsTransfer" jdbcType="DECIMAL" />
    <result column="transfer_warehouse_count" property="transferWarehouseCount" jdbcType="DECIMAL" />
    <result column="purchase_transfer" property="purchaseTransfer" jdbcType="DECIMAL" />
    <result column="purchase_cycle" property="purchaseCycle" jdbcType="INTEGER" />
     <result column="units_shipped_last_24_hrs" property="shippedLast24hs" jdbcType="INTEGER" />
     <result column="units_shipped_last_7_days" property="shippedLast7ds" jdbcType="INTEGER" />
     <result column="units_shipped_last_30_days" property="shippedLast30ds" jdbcType="INTEGER" />
     <result column="units_shipped_last_90_days" property="shippedLast90ds" jdbcType="INTEGER" />
     <result column="units_shipped_last_180_days" property="shippedLast180ds" jdbcType="INTEGER" />
     <result column="units_shipped_last_365_days" property="shippedLast365ds" jdbcType="INTEGER" />
    
  </resultMap>
  
  <select id="selectAll" resultMap="BaseResultMap" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jan 17 17:08:28 CST 2018.
    -->
    SELECT
		csr.id,
		csr.sku,
		csr.upc,
		csr.sku_name,
		cco.`name` AS dept_name,
		csr.fba_transfer,
		csr.fba_stock_count,
		csr.oversea_stock_transfer,
		csr.oversea_stock_count,
		csr.first_air_transfer,
		csr.first_ship_transfer,
		csr.first_trains_transfer,
		csr.transfer_warehouse_count,
		csr.purchase_transfer,
		csr.purchase_cycle,
		csr.units_shipped_last_24_hrs,
	    csr.units_shipped_last_7_days,
	    csr.units_shipped_last_30_days,
        csr.units_shipped_last_90_days,
        csr.units_shipped_last_180_days,
        csr.units_shipped_last_365_days
	FROM
		aukey_report.center_stock_report csr
	LEFT JOIN aukey_report.center_sku_depart_relation csdr ON csr.sku = csdr.sku_code
	LEFT JOIN cas.company_org cco ON cco.id = csdr.department_id
    where (fba_transfer > 0 OR fba_stock_count > 0 OR oversea_stock_transfer > 0 OR oversea_stock_count > 0 OR first_air_transfer > 0
				OR first_ship_transfer > 0 OR first_trains_transfer > 0 OR transfer_warehouse_count > 0 OR purchase_transfer > 0)
    <if test="ids!=null and ids.size!=0">
    	and csr.id in
    	<foreach collection="ids" index="index" item="item" open="(" close=")" separator=",">
    		#{item}
    	</foreach>
    </if>
    <if test="skuList!=null and skuList.size!=0">
    	and csr.sku in
    	<foreach collection="skuList" index="index" item="item" open="(" close=")" separator=",">
    		#{item}
    	</foreach>
    </if>
      <if test="stockType!=null">
    	and csr.stock_type=#{stockType}
    </if>
    <if test="upcList!=null and upcList.size!=0">
    	and csr.upc in
    	<foreach collection="upcList" index="index" item="item" open="(" close=")" separator=",">
    		#{item}
    	</foreach>
    </if>
    <if test="deptList!=null and deptList.size!=0">
    	and csdr.department_id in
    	<foreach collection="deptList" index="index" item="item" open="(" close=")" separator=",">
    		#{item}
    	</foreach>
    </if>
    <if test="initDepts!=null and initDepts.size!=0">
    	and cco.id in
    	<foreach collection="initDepts" index="index" item="item" open="(" close=")" separator=",">
    		#{item}
    	</foreach>
    </if>
    ORDER BY
	csr.id DESC
    <if test="pageSize!=null and pageNumber!=null">
    	limit #{pageNumber},#{pageSize}
    </if>
  </select>
  <select id="selectAllCount" resultType="java.lang.Integer" parameterType="map">
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Wed Jan 17 17:08:28 CST 2018.
    -->
    select 
    	count(1)
    from 
    aukey_report.center_stock_report csr
	LEFT JOIN aukey_report.center_sku_depart_relation csdr ON csr.sku = csdr.sku_code
	LEFT JOIN cas.company_org cco ON cco.id = csdr.department_id
    where (fba_transfer > 0 OR fba_stock_count > 0 OR oversea_stock_transfer > 0 OR oversea_stock_count > 0 OR first_air_transfer > 0
				OR first_ship_transfer > 0 OR first_trains_transfer > 0 OR transfer_warehouse_count > 0 OR purchase_transfer > 0)
    <if test="skuList!=null and skuList.size!=0">
    	and csr.sku in
    	<foreach collection="skuList" index="index" item="item" open="(" close=")" separator=",">
    		#{item}
    	</foreach>
    </if>
      <if test="stockType!=null">
    	and csr.stock_type=#{stockType}
    </if>
    <if test="upcList!=null and upcList.size!=0">
    	and csr.upc in
    	<foreach collection="upcList" index="index" item="item" open="(" close=")" separator=",">
    		#{item}
    	</foreach>
    </if>
    <if test="deptList!=null and deptList.size!=0">
    	and csdr.department_id in
    	<foreach collection="deptList" index="index" item="item" open="(" close=")" separator=",">
    		#{item}
    	</foreach>
    </if>
    <if test="initDepts!=null and initDepts.size!=0">
    	and cco.id in
    	<foreach collection="initDepts" index="index" item="item" open="(" close=")" separator=",">
    		#{item}
    	</foreach>
    </if>
  </select>
  <!-- 查询fba库存 -->
  <select id="selectFbaStock" parameterType="map" resultType="com.aukey.report.domain.centerstock.CenterStockQuery">
  	SELECT
		t2.by_warehouse_name AS targetStockName,
		SUM(t1.quantity) AS stockCount
	FROM
		fba_stock.fulfillment_current_inventory t1
	LEFT JOIN supply_sign.center_warehouse_fba_by_mapping t2 ON t1.fulfillment_center_id = t2.fba_center_id
	AND t1.country = t2.country_short
	WHERE 1=1 
	<if test="sku!=null">
		and t1.company_sku = #{sku}
	</if>
	GROUP BY t1.company_sku,t2.by_warehouse_id
	<if test="pageSize!=null and pageNumber!=null">
		limit #{pageNumber},#{pageSize}
	</if>
  </select>
  <select id="selectFbaStockCount" parameterType="map" resultType="java.lang.Integer">
  	SELECT COUNT(1) FROM 
  	(
  		SELECT
			t1.company_sku
		FROM
			fba_stock.fulfillment_current_inventory t1
		LEFT JOIN supply_sign.center_warehouse_fba_by_mapping t2 ON t1.fulfillment_center_id = t2.fba_center_id
		AND t1.country = t2.country_short
		WHERE 1=1 
		<if test="sku!=null">
			and t1.company_sku = #{sku}
		</if>
		GROUP BY t1.company_sku,t2.by_warehouse_id	
  	) t
  </select>
  <!-- 查询海外转运在途-->
  <select id="selectOverseaStockTransfer" parameterType="map" resultType="com.aukey.report.domain.centerstock.CenterStockQuery">
  	SELECT
		t4.`name` AS targetStockName, 
		SUM(t3.box_count - t3.quantity_received) AS stockCount,
		(SELECT create_date FROM supply_sign.center_idle_stock_record WHERE relation_no=t1.transfer_no AND sku=t2.to_wsku AND type='10' LIMIT 1) AS date
	FROM
		supply_sign.center_transfer t1
	LEFT JOIN supply_sign.center_transfer_detail t2 ON t1.transfer_no = t2.transfer_no
	LEFT JOIN supply_sign.center_transfer_detail_box t3 ON t3.transfer_detail_id = t2.transfer_detail_id
	LEFT JOIN product_ms.stock t4 ON t4.stock_id = t1.to_warehouse_id
	WHERE
		t1.data_status IN ('4', '6')
	AND t1.from_warehouse_id IN (
		SELECT
			stock_id
		FROM
			product_ms.stock
		WHERE
			stock_type = '11'
	)
	<if test="sku!=null">
		AND t2.to_wsku = #{sku}
	</if>
	GROUP BY
		t2.to_wsku,
		t1.to_warehouse_id
	<if test="pageSize!=null and pageNumber!=null">
		limit #{pageNumber},#{pageSize}
	</if>
  </select>
  <select id="selectOverseaStockTransferCount" parameterType="map" resultType="java.lang.Integer">
  	SELECT COUNT(1) FROM 
	(
		SELECT
			t2.to_wsku
		FROM
			supply_sign.center_transfer t1
		LEFT JOIN supply_sign.center_transfer_detail t2 ON t1.transfer_no = t2.transfer_no
		LEFT JOIN supply_sign.center_transfer_detail_box t3 ON t3.transfer_detail_id = t2.transfer_detail_id
		LEFT JOIN product_ms.stock t4 ON t4.stock_id = t1.to_warehouse_id
		WHERE
			t1.data_status IN ('4', '6')
		AND t1.from_warehouse_id IN (
			SELECT
				stock_id
			FROM
				product_ms.stock
			WHERE
				stock_type = '11'
		)
		<if test="sku!=null">
			AND t2.to_wsku = #{sku}
		</if>
		GROUP BY
			t2.to_wsku,
			t1.to_warehouse_id
	) a
  </select>
  <!-- 头程在途 -->
  <select id="selectFirstAirTransfer" parameterType="map" resultType="com.aukey.report.domain.centerstock.CenterStockQuery">
  	SELECT
		t3.`name` AS targetStockName,
		SUM(t1.box_count) AS stockCount,
		t2.actual_outtime AS date
	FROM
		supply_delivery.transfer_detail t1
	INNER JOIN supply_delivery.transfer_slip t2 ON t1.transfer_id = t2.transfer_id
	LEFT JOIN product_ms.stock t3 ON t3.stock_id = t1.warehouse_id
	WHERE t2.transfer_status = '1' AND t2.data_status='1'
	<if test="sku!=null">
		AND t1.sku=#{sku}
	</if>
	<if test="type!=null">
		AND t2.transport_type=#{type}
	</if>
	GROUP BY t1.sku,t2.transport_type,t1.warehouse_id
	<if test="pageSize!=null and pageNumber!=null">
		limit #{pageNumber},#{pageSize}
	</if>
  </select>
  <select id="selectFirstAirTransferCount" parameterType="map" resultType="java.lang.Integer">
  	SELECT COUNT(1) FROM 
	(
		SELECT
			t1.sku
		FROM
			supply_delivery.transfer_detail t1
		INNER JOIN supply_delivery.transfer_slip t2 ON t1.transfer_id = t2.transfer_id
		LEFT JOIN product_ms.stock t3 ON t3.stock_id = t1.warehouse_id
		WHERE t2.transfer_status = '1' AND t2.data_status='1'
		<if test="sku!=null">
			AND t1.sku=#{sku}
		</if>
		<if test="type!=null">
			AND t2.transport_type=#{type}
		</if>
		GROUP BY t1.sku,t2.transport_type,t1.warehouse_id
	)a
  </select>
  <!-- 国内中转仓库存 -->
  <select id="selectTransferWarehouse" parameterType="map" resultType="com.aukey.report.domain.centerstock.CenterStockQuery">
  	SELECT
		inventory_name AS targetStockName,
		available_inventory AS canUseStock,
		usage_inventory AS noCanUseStock,
		actual_inventory AS stockCount
	FROM
		aukey_report.stock_report
	WHERE
		inventory IN (
			SELECT
				stock_id
			FROM
				product_ms.stock
			WHERE
				stock_type = '3'
		)
		<if test="sku!=null">
			AND sku=#{sku}
		</if>
		<if test="pageSize!=null and pageNumber!=null">
			limit #{pageNumber},#{pageSize}
		</if>
  </select>
  <select id="selectTransferWarehouseCount" parameterType="map" resultType="java.lang.Integer">
  	SELECT
		COUNT(1)
	FROM
		aukey_report.stock_report
	WHERE
		inventory IN (
			SELECT
				stock_id
			FROM
				product_ms.stock
			WHERE
				stock_type = '3'
		) 
		<if test="sku!=null">
			AND sku=#{sku}
		</if>
  </select>
  <!-- 采购订单在途 -->
  <select id="selectPurchaseTransfer" parameterType="map" resultType="com.aukey.report.domain.centerstock.CenterStockQuery">
  	SELECT
		sum(pd.quantity) - IFNULL(sum(sr.supply_quantity),0) - ifnull(sum(rt.refund_quality),0) stockCount,
		t2.`name` AS targetStockName,
		(SELECT leader_create_time FROM supply_chain.purchase_order_flow WHERE purchase_order_id = po.purchase_order_id LIMIT 1) AS date
	FROM
		supply_chain.purchase_order po
	JOIN supply_chain.purchase_demand pd ON pd.purchase_order_id = po.purchase_order_id
	JOIN supply_chain.requirement rt ON pd.purchase_demand_id = rt.requirement_no
	LEFT JOIN supply_sign.storage_requirement sr ON pd.purchase_demand_id = sr.requirement_no
	AND sr.`type` = '1'
	LEFT JOIN (
		SELECT
			t.purchase_order_id,
			sum(demand.refund_quality) refund_quality
		FROM
			supply_chain.purchase_return_order t
		INNER JOIN supply_chain.purchase_return_demand demand ON t.purchase_return_id = demand.purchase_return_id
		WHERE
			t.order_status IN ('4', '6')
		AND t.data_status = '1'
		GROUP BY
			t.purchase_order_id
	) rt ON po.purchase_order_id = rt.purchase_order_id
	LEFT JOIN product_ms.stock t2 ON t2.stock_id = pd.warehouse_id
	WHERE
		po.order_status in ('2', '3')
	AND po.data_status = '1'
	<if test="sku!=null">
		AND pd.sku_code=#{sku}
	</if>
	GROUP BY
		pd.sku_code, pd.warehouse_id
	<if test="pageSize!=null and pageNumber!=null">
			limit #{pageNumber},#{pageSize}
	</if>
  </select>
  
  <select id="selectPurchaseTransferCount" parameterType="map" resultType="java.lang.Integer">
  	SELECT COUNT(1) FROM
	(
		SELECT
			pd.sku_code
		FROM
			supply_chain.purchase_order po
		JOIN supply_chain.purchase_demand pd ON pd.purchase_order_id = po.purchase_order_id
		JOIN supply_chain.requirement rt ON pd.purchase_demand_id = rt.requirement_no
		LEFT JOIN supply_sign.storage_requirement sr ON pd.purchase_demand_id = sr.requirement_no
		AND sr.`type` = '1'
		LEFT JOIN (
			SELECT
				t.purchase_order_id,
				sum(demand.refund_quality) refund_quality
			FROM
				supply_chain.purchase_return_order t
			INNER JOIN supply_chain.purchase_return_demand demand ON t.purchase_return_id = demand.purchase_return_id
			WHERE
				t.order_status IN ('4', '6')
			AND t.data_status = '1'
			GROUP BY
				t.purchase_order_id
		) rt ON po.purchase_order_id = rt.purchase_order_id
		LEFT JOIN product_ms.stock t2 ON t2.stock_id = pd.warehouse_id
		WHERE
			po.order_status in ('2', '3')
		AND po.data_status = '1'
		<if test="sku!=null">
			AND pd.sku_code=#{sku}
		</if>
		GROUP BY
			pd.sku_code, pd.warehouse_id
	) a
  </select>
  <!-- FBA退货在途 -->
  <select id="selectFbaTransfer" parameterType="map" resultType="com.aukey.report.domain.centerstock.CenterStockQuery">
  	SELECT
		s.`name` AS targetStockName,
		SUM(
			t1.return_quantity - t1.storage_quantity
		) AS stockCount,
		t2.create_date AS date
	FROM
		supply_sign.center_fba_return_packages t1
	LEFT JOIN supply_sign.center_fba_return_plan t2 ON t1.return_plan_no = t2.return_plan_no
	LEFT JOIN product_ms.stock s ON s.stock_id = t2.warehouse_id
	WHERE
		t1.`status` IN (7, 9, 10)
		<if test="sku!=null">
			and t1.SKU=#{sku}
		</if>
	GROUP BY
		t1.SKU,
		t2.warehouse_id
	<if test="pageSize!=null and pageNumber!=null">
			limit #{pageNumber},#{pageSize}
	</if>
  </select>
  
  <select id="selectFbaTransferCount" parameterType="map" resultType="java.lang.Integer">
  	select count(1) from 
  	(
  		SELECT
			t1.SKU
		FROM
			supply_sign.center_fba_return_packages t1
		LEFT JOIN supply_sign.center_fba_return_plan t2 ON t1.return_plan_no = t2.return_plan_no
		LEFT JOIN product_ms.stock s ON s.stock_id = t2.warehouse_id
		WHERE
			t1.`status` IN (7, 9, 10)
			<if test="sku!=null">
				and t1.SKU=#{sku}
			</if>
		GROUP BY
			t1.SKU,
			t2.warehouse_id
  	) a
  </select>
  <!-- 获取一级部门的信息 -->
  <select id="findAllOrgs" resultType="java.util.HashMap" parameterType="map">
        SELECT id, name FROM cas.company_org WHERE code = 7000 AND parent_id!=2
        <if test="ids!=null and ids.size!=0">
        	and id in
        	<foreach collection="ids" index="index" item="item" open="(" close=")" separator=",">
        		#{item}
        	</foreach>
        </if>
   </select>
</mapper>