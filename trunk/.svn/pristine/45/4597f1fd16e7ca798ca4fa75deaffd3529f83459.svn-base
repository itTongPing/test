DROP PROCEDURE IF EXISTS aukey_report.sync_purchase_sell_info;
CREATE PROCEDURE aukey_report.sync_purchase_sell_info()
BEGIN
TRUNCATE TABLE aukey_report.purchase_sell_report;
INSERT INTO aukey_report.purchase_sell_report(
		id,
		legaler,
		legaler_name,
		company_name,
		sku,
		sku_name,
		warehouse,
		warehouse_name,
		category_name,
		count_in,
		price_in,
		volume_in,
		count_out,
		price_out,
    volume_out,
		count_stock,
		price_stock,
    volume_stock,
	  count_occupy,
	   price_occupy,
     volume_occupy,
	   count_onway,
	   price_onway,
     volume_onway,
     document_date
		)
select 
UUID(),
a.legaler,
co.corporation_name legaler_name,
corg.`name` company_name,
a.sku,
sku.`name` sku_name,
a.warehouse,
s.`name` warehouse_name,
cg.`name` category_name,
sum(a.quantity_in) count_in,
sum(a.quantity_in*ssp.price*ssp.currency_rate) price_in,
sum(a.quantity_in * p.goods_package_height * p.goods_package_length * p.goods_package_width / 1000000) volume_in,
sum(a.quantity_out) count_out,
sum(a.quantity_out*ssp.price*ssp.currency_rate) price_out,
sum(a.quantity_out * p.goods_package_height * p.goods_package_length * p.goods_package_width/ 1000000) volume_out,
sum(a.quantity_sum) count_stock,
sum(a.quantity_sum*ssp.price*ssp.currency_rate) price_stock,
sum(a.quantity_sum * p.goods_package_height * p.goods_package_length * p.goods_package_width / 1000000) volume_stock,
sum(a.quantity_usage_sum) count_occupy,
sum(a.quantity_usage_sum*ssp.price*ssp.currency_rate) price_occupy,
sum(a.quantity_usage_sum * p.goods_package_height * p.goods_package_length * p.goods_package_width / 1000000) volume_occupy,
sum(a.quantity_onway) count_onway,
sum(a.quantity_onway*ssp.price*ssp.currency_rate) volume_onway,
sum(a.quantity_onway * p.goods_package_height * p.goods_package_length * p.goods_package_width / 1000000) volume_onway,
a.date
from
(
select 
legaler,
sku,
warehouse,
sum(
CASE
   WHEN business_type IN (
    '普通采购',
    '转SKU入库',
    '无主调拨入库',
    '无主盘盈入库',
    '海外调海外入库',
    'FBA退货入库',
    '期初库存'
   )  then quantity end
) quantity_in,
sum(
   CASE
   WHEN business_type IN (
    '调拨出库',
    '采购退货',
    '其他出库',
    '转SKU出库',
    '需求单调拨出库',
    '需求单盘亏出库',
    '无主调拨出库',
    '无主盘亏出库',
    '无主海外调拨出库',
    '海外调海外出库'
   ) THEN
    quantity
   END
  ) quantity_out,  
null quantity_sum,
null quantity_usage_sum,
null quantity_onway,
DATE_FORMAT(document_date,'%Y-%m-%d') as date
from aukey_report.sku_report 
GROUP BY
legaler,
sku,
warehouse,
document_date
union all 

select 
legaler,
sku,
inventory warehouse,
null quantity_in,
null quantity_out,
sum(IFNULL(actual_inventory,0)) quantity_sum,
sum(IFNULL(usage_inventory,0)) quantity_usage_sum,
null quantity_onway,
null as date
from aukey_report.stock_report sr
GROUP BY
legaler,
sku,
inventory

union all
SELECT
	3 AS legaler,
	b.sku ,
  a.warehouse_id warehouse, 
	null quantity_in,
	null quantity_out,
	null quantity_sum,
	null quantity_usage_sum,
  sum(ifnull(b.box_count,0) - ifnull(tpa.arrival_qty,0)) quantity_onway,/*由调拨的数量-部分到货的数量 = 在途数量*/
	null as date
 FROM
  supply_delivery.transfer_slip a /*调拔主表*/
 JOIN supply_delivery.transfer_detail b ON a.transfer_id = b.transfer_id /*调拨详细表*/
 INNER JOIN aukey_tms.logistics_transport_segment lts on a.transfer_no = lts.reference_no
inner join aukey_tms.logistics_transport_segment_time ltst on lts.logistics_transport_segment_id=ltst.logistics_transport_segment_id
 LEFT JOIN supply_delivery.transfer_part_arrival tpa ON tpa.box_no = b.box_no and tpa.transfer_id =a.transfer_id and tpa.requirement_no=b.requirement_no and tpa.delivery_id=b.delivery_id 
 WHERE  a.data_status='1' and b.data_status='1'  /*未删除状态*/
and a.transfer_status in ('1','3')  /*已出库，部分到货*/
and ltst.current_state in ('1131','1231')
GROUP BY 
b.sku,
a.warehouse_id
) a
LEFT JOIN (select sp.sku_code,sp.price,sp.currency_name,cs.currency_rate,max(sp.update_date)  /*查询sku对应的最新的价格信息*/
						from  aukey_report.sku_report aa LEFT JOIN product_ms.sku_supplier_price_new sp on aa.sku = sp.sku_code
						LEFT JOIN (select currency_code,currency_rate,max(update_time) from product_ms.currency_set where audit_status = '1' group by currency_code) cs /*查询币种最新的汇率*/
                       on cs.currency_code = sp.currency_name 
						where audit_status = '1'
						group by sp.sku_code)ssp on a.sku = ssp.sku_code
LEFT JOIN product_ms.sku on a.sku=sku.`code`
LEFT JOIN product_ms.sku_spec p on a.sku=p.`code`
left join product_ms.stock s on a.warehouse = s.stock_id
left join product_ms.category cg on sku.category_id = cg.cate_id
LEFT JOIN supplier2.base_corporation co ON a.legaler = co.corporation_id
left join aukey_report.center_sku_depart_relation sdr on a.sku = sdr.sku_code
left join cas.company_org corg on sdr.department_id = corg.id
where a.warehouse not in ('12','13') 
GROUP BY
a.legaler,
a.sku,
a.warehouse,
a.date;
END